<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>EPAPI: Documentation for EPAPI - Erlang Port API library -- version 0.3</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li class="current"><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Documentation for EPAPI - Erlang Port API library -- version 0.3</h1>
<p>
This library helps build Erlang Port Drivers - bridging simple messages between C/C++ and Erlang. Communication is served by a file based pipe (i.e. one "in" and one "out") which defaults to "stdin" and "stdout".<h2><a class="anchor" name="msg_struc">
Message Structure</a></h2>
The message format supported follows:<p>
<div class="fragment"><pre class="fragment">   {<a class="code" href="epapi__msg_8h.html#24560a68d244bad65fd7470cddb72177">msg_type</a>, {Message}}
</pre></div><p>
where <em>msg_type</em> corresponds to an Erlang ATOM and <em>Message</em> corresponds to an Erlang TUPLE. The <em>Message</em> tuple can be formed of the following primitives:<p>
<ul>
<li>ATOM </li>
<li>STRING </li>
<li>LONG </li>
<li>DOUBLE</li>
</ul>
<h2><a class="anchor" name="usage">
Usage</a></h2>
To send and receive messages, message <em>types</em> must be registered. This process is accomplished through the <a class="el" href="classMsgHandler.html#53974d86bc7b1716503ccbba1639a0e0">MsgHandler::registerType()</a> method.<h3><a class="anchor" name="rx">
Receiving</a></h3>
<div class="fragment"><pre class="fragment"><span class="preprocessor">            #include &lt;<a class="code" href="epapi_8h.html">epapi.h</a>&gt;</span>

                <a class="code" href="classPktHandler.html" title="Packet Handler class declaration.">PktHandler</a> *ph = <span class="keyword">new</span> <a class="code" href="classPktHandler.html" title="Packet Handler class declaration.">PktHandler</a>();
                <a class="code" href="classMsgHandler.html">MsgHandler</a> *mh = <span class="keyword">new</span> <a class="code" href="classMsgHandler.html">MsgHandler</a>(ph);

                <span class="comment">//Register a message type</span>
                <span class="comment">// {echo, {Counter}}</span>
                mh-&gt;<a class="code" href="classMsgHandler.html#53974d86bc7b1716503ccbba1639a0e0">registerType</a>(1, <span class="stringliteral">"echo"</span>, <span class="stringliteral">"l"</span> );

                <span class="comment">//Wait for a message</span>
                <a class="code" href="classMsg.html">Msg</a> *m;
                result = mh-&gt;<a class="code" href="classMsgHandler.html#d9322ab0abd919cc9908f52bc1aa2169">rx</a>(&amp;m);

                <span class="comment">//Verify return code</span>
                <span class="keywordflow">if</span> (result) {
                        <span class="comment">//handle error</span>
                        printf(<span class="stringliteral">"ERROR, message: %s"</span>, mh-&gt;<a class="code" href="classepapiBase.html#08c061372f09f989a74aff2a4e2ebbd7">strerror</a>());
                        <span class="comment">// ...</span>
                }
                <span class="comment">//Consume message</span>
                ...

                <span class="comment">//Destroy message</span>
                <span class="keyword">delete</span> m;
</pre></div><h3><a class="anchor" name="tx">
Transmitting</a></h3>
<div class="fragment"><pre class="fragment">     <span class="keywordtype">int</span> counter;
     result =  mh-&gt;<a class="code" href="classMsgHandler.html#511d52b5e26c58657c3afcfb4be8450f">send</a>(1, counter);
     <span class="comment">// check result</span>
</pre></div><h3><a class="anchor" name="error">
Error Handling</a></h3>
All methods return 0 on success and 1 on failure. The error code is available through the get_errno() method, eg.:<p>
<div class="fragment"><pre class="fragment">      <a class="code" href="classMsgHandler.html">MsgHandler</a> *mh;
      <span class="keywordtype">int</span> errnum=mh-&gt;<a class="code" href="classepapiBase.html#022c97d1ec933c5bc1b1c4cb3dcebd35">get_errno</a>();
      <span class="comment">// ...</span>
      <a class="code" href="classPktHandler.html" title="Packet Handler class declaration.">PktHandler</a> *ph;
      <span class="keywordtype">int</span> errnum=ph-&gt;<a class="code" href="classepapiBase.html#022c97d1ec933c5bc1b1c4cb3dcebd35">get_errno</a>();
</pre></div><h3><a class="anchor" name="erlang">
Erlang side</a></h3>
<div class="fragment"><pre class="fragment">%% Author: Jean-Lou Dupont
%% Created: 2009-06-03
-module(t1).

%%
%% API
%%
-export([start/0, start/1, stop/0, echo/1]).

%% <span class="keyword">internal</span>
-export([init/2, loop/1]).

%%
%% Local Functions
%%

echo(X) -&gt;
        ?MODULE ! {echo, {X}}.

start() -&gt;
    start(<span class="stringliteral">""</span>).

start(Param) -&gt;
    spawn_link(?MODULE, init, [<span class="stringliteral">"/tmp/decho"</span>, Param]).

stop() -&gt;
    ?MODULE ! stop.

init(ExtPrg, Param) -&gt;
    <span class="keyword">register</span>(?MODULE, <span class="keyword">self</span>()),
    process_flag(trap_exit, <span class="keyword">true</span>),
    Port = open_port({spawn, ExtPrg++<span class="stringliteral">" "</span>++Param}, [{packet, 2}, binary, exit_status]),
    loop(Port).

loop(Port) -&gt;
    receive

                {echo,<a class="code" href="classMsg.html">Msg</a>} -&gt;
                        {Counter} = <a class="code" href="classMsg.html">Msg</a>,
                        BinMsg = {echo, {Counter}},
                        io:format(<span class="stringliteral">"request to send 'echo' message [~p]~n"</span>, [BinMsg]),
                        erlang:port_command(Port, term_to_binary(BinMsg));

                stop -&gt;
                        io:format(<span class="stringliteral">"called [stop]"</span>),
                        erlang:port_close(Port),
                        exit(normal);

                {Port, {data, Data}} -&gt;
                        io:format(<span class="stringliteral">"Message raw[~p]~n"</span>, [Data]),
                        Decoded = binary_to_term(Data),
                        io:format(<span class="stringliteral">"Message! Decoded[~p]~n"</span>, [Decoded]);

                Result -&gt;
                        Result
    end,
        loop(Port).
</pre></div><h2><a class="anchor" name="releases">
Releases</a></h2>
<ul>
<li>0.1 - Initial Release </li>
<li>0.2 - Set the msg_type correctly </li>
<li>0.3 - Add <a class="el" href="classTermHandler.html">TermHandler</a> functionality (required by erlang-dbus)</li>
</ul>
<dl class="note" compact><dt><b>Note:</b></dt><dd>Only packet header with length field=2 is supported. </dd></dl>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Sep 30 17:19:25 2009 for EPAPI by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
